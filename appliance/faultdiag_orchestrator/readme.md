
# 故障诊断调度适配层

自动故障诊断系统是一个用于分布式环境中自动收集、解析和诊断系统日志的工具集。该系统主要由两个核心组件构成：调度器（Orchestrator）和清洗器（Parse Agent）。

## 系统架构

### Orchestrator 调度器

调度器是整个系统的中央控制器，负责协调整个故障诊断流程。

#### 主要功能：

1. **配置管理**
   - 读取并验证JSON格式的配置文件
   - 包含本地和远程工作节点信息
   - 定义需要分析的日志路径

2. **组件安装**
   - 在本地和远程节点自动安装诊断组件
   - 支持国内版（ascend-fd）和国际版（alan-fd）诊断包
   - 验证安装结果

3. **环境检测**
   - 检测是单节点还是双节点环境
   - 验证远程节点的可访问性
   - 验证SSH免密登录配置

4. **日志处理协调**
   - 部署清洗器到各个节点
   - 协调日志收集和解析过程
   - 收集解析结果

5. **诊断执行**
   - 运行最终的诊断程序
   - 生成诊断报告

#### 工作流程：

1. 解析命令行参数，获取配置文件和输出目录
2. 读取并验证配置文件
3. 安装所需的诊断组件
4. 在本地和远程工作节点部署并运行清洗器
5. 收集解析后的日志数据
6. 执行诊断程序并生成最终报告

### Parse Agent 清洗器 

清洗器是一个轻量级组件，部署在每个工作节点上，用于收集和解析日志。

#### 主要功能：

1. **多源日志收集**
   - 进程日志 (process_log)
   - 设备日志 (device_log)，包括华为昇腾NPU日志
   - 主机操作系统日志 (host_log)
   - 训练日志 (train_log)

2. **灵活部署**
   - 可以独立运行或由调度器协调运行
   - 支持多种运行模式

3. **远程结果传输**
   - 通过SSH将解析结果发送回调排器
   - 支持临时目录管理和安全传输

4. **组件集成**
   - 与不同的诊断组件配合工作 (ascend-fd, alan-fd)

#### 运行模式：

1. **独立模式**：直接运行并将结果输出到本地路径
2. **协调模式**：由调度器部署运行，并通过SSH返回结果

## 使用方法

### 配置文件示例

创建一个JSON格式的配置文件：

```json
{
    "local_worker": {
        "user": "user1",
        "ip": "192.168.1.10"
    },
    "remote_worker": {
        "user": "user2", 
        "ip": "192.168.1.11"
    },
    "whl_pkg_path": "/path/to/diagnostic-package.whl",
    "log_path": {
        "process_log": "/var/log/process.log",
        "device_log": "/var/log/device/",
        "host_log": "/var/log/",
        "train_log": "/var/log/train.log"
    }
}
```

### 运行命令

```bash
python3 orchestrator.py -i config.json -o /output/path
```

系统会自动完成以下操作：
1. 验证配置文件
2. 安装必要的诊断组件
3. 在所有配置的工作节点上部署清洗器
4. 收集和解析各节点日志
5. 生成最终诊断报告

## 环境要求

- Python 3.x
- SSH访问权限（用于远程节点通信）
- 对应的诊断wheel包（ascend-fd或alan-fd）
- 各节点上的必要日志文件

## 注意事项

1. 确保所有工作节点具有相同的目录结构，否则清洗器可能会失败
2. 远程节点需要配置SSH免密登录
3. 确保指定的日志路径在对应节点上存在且可访问
4. 网络连接稳定，特别是对于双节点环境
5. 对于大文件（超过100MB），系统会拒绝处理以防止内存问题