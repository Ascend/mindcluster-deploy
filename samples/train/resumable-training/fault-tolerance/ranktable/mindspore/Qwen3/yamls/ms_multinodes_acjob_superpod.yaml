apiVersion: v1
kind: ConfigMap
metadata:
  name: rings-config-default-test-mindspore      # The value of JobName must be the same as the name attribute of the following job. The prefix rings-config- cannot be modified.
  namespace: default                      # Select a proper namespace based on the site requirements. (The namespaces of ConfigMap and Job must be the same. In addition, if the component of MindX-add exists, the vcjob namespace cannot be used)
  labels:
    ring-controller.atlas: ascend-910b    # The Value cannot be modified. Service operations will be performed based on this label
data:
  hccl.json: |
    {
        "status":"initializing"
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: reset-config-default-test-mindspore      # The value of JobName must be the same as the name attribute of the following job. The prefix reset-config- cannot be modified.
  namespace: default                      # Name Space must be set to "default"
  labels:
    reset: "true"
data:
  reset.json: |
    {
        "status":"initializing"
    }
  checkCode: ""
---

apiVersion: mindxdl.gitee.com/v1
kind: AscendJob
metadata:
  name: default-test-mindspore
  labels:
    framework: mindspore
    fault-scheduling: "force"
    process-recover-enable: "on"
    fault-retry-times: "10"
    ring-controller.atlas: ascend-910b
  annotations:
    recover-strategy: "retry,recover,dump,exit"
    sp-block: "32"
spec:
  schedulerName: volcano    # work when enableGangScheduling is true
  runPolicy:
    backoffLimit: 10       # maximum number of global rescheduling times, including the number of rescheduling times upon service plane and non-service plane faults.
    schedulingPolicy:
      minAvailable: 2       # work when enableGangScheduling is true
      queue: default
  successPolicy: AllWorkers
  replicaSpecs:
    Scheduler:
      replicas: 1  #Scheduler can only be 1
      restartPolicy: Never
      template:
        metadata:
          labels:
            ring-controller.atlas: ascend-910b
        spec:
          terminationGracePeriodSeconds: 360
          automountServiceAccountToken: false
          nodeSelector:                        # modify according to the actual situation
            host-arch: huawei-arm
          hostNetwork: true
          containers:
            - name: ascend # do not modify
              image: mindformers-dl:v1       # training framework image， which can be modified
              imagePullPolicy: IfNotPresent
              env:
                - name: XDL_IP                                       # IP address of the physical node, which is used to identify the node where the pod is running
                  valueFrom:
                    fieldRef:
                      fieldPath: status.hostIP
                # ASCEND_VISIBLE_DEVICES env variable is used by ascend-docker-runtime when in the whole card scheduling scene with volcano scheduler.
                # Please delete it when in the static vNPU scheduling, dynamic vNPU scheduling, volcano without Ascend-volcano-plugin, without volcano scenes.
                - name: ASCEND_VISIBLE_DEVICES
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.annotations['huawei.com/Ascend910']               # The value must be the same as resources.requests
                - name: TTP_PORT                # 用于mindio通信，请注意上下保持一致
                  value: "8000"
                - name: POD_IP
                  valueFrom:
                    fieldRef:
                      fieldPath: status.podIP
              command:                           # training command, which can be modified
                - /bin/bash
                - -c
                - |
                 cd /job/code/;bash scripts/msrun_launcher.sh "run_mindformer.py --config configs/qwen3/pretrain_qwen3_32b_4k.yaml --auto_trans_ckpt False --use_parallel True --run_mode train"
              ports:                          # default value containerPort: 2222 name: ascendjob-port if not set
                - containerPort: 2222         # determined by user
                  name: ascendjob-port        # do not modify
                - containerPort: 8000         # 用于mindio通信，请注意上下保持一致
                  name: ttp-port
                - containerPort: 9601         # TaskD通信使用的端口
                  name: taskd-port
              resources:
                limits:
                  huawei.com/Ascend910: 16
                requests:
                  huawei.com/Ascend910: 16
              volumeMounts:
                - name: code
                  mountPath: /job/code
                - name: data
                  mountPath: /job/data
                - name: ascend-driver
                  mountPath: /usr/local/Ascend/driver
                - name: dshm
                  mountPath: /dev/shm
                - name: localtime
                  mountPath: /etc/localtime
                - name: reset-config
                  mountPath: /user/restore/reset/config
                  readOnly: true
                - name: ranktable
                  mountPath: /user/serverid/devindex/config
          volumes:
            - name: code
              nfs: # 此处是通过NFS方式挂载代码，请根据实际情况修改path
                server: 127.0.0.1
                path: "/data/atlas_dls/public/code/QWEN3_for_MS_code/"
            - name: data
              nfs: # 此处是通过NFS方式挂载数据集，请根据实际情况修改path
                server: 127.0.0.1
                path: "/data/atlas_dls/public/code/QWEN3_for_MS_code/dataset"
            - name: ascend-driver
              hostPath:
                path: /usr/local/Ascend/driver
            - name: dshm
              emptyDir:
                medium: Memory
            - name: localtime
              hostPath:
                path: /etc/localtime
            - name: ranktable
              nfs: # 此处是通过NFS方式挂载ranktable
                server: 127.0.0.1
                path: /user/mindx-dl/ranktable/default.default-test-mindspore
            - name: reset-config
              hostPath:
                path: /user/restore/reset/default.reset-config-default-test-mindspore
    Worker:
      replicas: 1
      restartPolicy: Never
      template:
        metadata:
          labels:
            ring-controller.atlas: ascend-910b
        spec:
          terminationGracePeriodSeconds: 360
          automountServiceAccountToken: false
          nodeSelector: # modify according to the actual situation
            host-arch: huawei-arm
          hostNetwork: true
          containers:
            - name: ascend # do not modify
              image: mindformers-dl:v1       # training framework image， which can be modified
              imagePullPolicy: IfNotPresent
              env:
                - name: XDL_IP                                       # IP address of the physical node, which is used to identify the node where the pod is running
                  valueFrom:
                    fieldRef:
                      fieldPath: status.hostIP
                # ASCEND_VISIBLE_DEVICES env variable is used by ascend-docker-runtime when in the whole card scheduling scene with volcano scheduler.
                # Please delete it when in the static vNPU scheduling, dynamic vNPU scheduling, volcano without Ascend-volcano-plugin, without volcano scenes.
                - name: ASCEND_VISIBLE_DEVICES
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.annotations['huawei.com/Ascend910']               # The value must be the same as resources.requests
                - name: TTP_PORT                # 用于mindio通信，请注意上下保持一致
                  value: "8000"
                - name: POD_IP
                  valueFrom:
                    fieldRef:
                      fieldPath: status.podIP
              command: # training command, which can be modified
                - /bin/bash
                - -c
                - |
                 cd /job/code/;bash scripts/msrun_launcher.sh "run_mindformer.py --config configs/qwen3/pretrain_qwen3_32b_4k.yaml --auto_trans_ckpt False --use_parallel True --run_mode train"
              ports: # default value containerPort: 2222 name: ascendjob-port if not set
                - containerPort: 2222         # determined by user
                  name: ascendjob-port        # do not modify
                - containerPort: 8000         # 用于mindio通信，请注意上下保持一致
                  name: ttp-port
                - containerPort: 9601         # TaskD通信使用的端口
                  name: taskd-port
              resources:
                limits:
                  huawei.com/Ascend910: 16
                requests:
                  huawei.com/Ascend910: 16
              volumeMounts:
                - name: code
                  mountPath: /job/code
                - name: data
                  mountPath: /job/data
                - name: ascend-driver
                  mountPath: /usr/local/Ascend/driver
                - name: dshm
                  mountPath: /dev/shm
                - name: localtime
                  mountPath: /etc/localtime
                - name: reset-config
                  mountPath: /user/restore/reset/config
                  readOnly: true
                - name: ranktable
                  mountPath: /user/serverid/devindex/config
          volumes:
            - name: code
              nfs: # 此处是通过NFS方式挂载代码，请根据实际情况修改path
                server: 127.0.0.1
                path: "/data/atlas_dls/public/code/QWEN3_for_MS_code/"
            - name: data
              nfs: # 此处是通过NFS方式挂载数据集，请根据实际情况修改path
                server: 127.0.0.1
                path: "/data/atlas_dls/public/code/QWEN3_for_MS_code/dataset"
            - name: ascend-driver
              hostPath:
                path: /usr/local/Ascend/driver
            - name: dshm
              emptyDir:
                medium: Memory
            - name: localtime
              hostPath:
                path: /etc/localtime
            - name: ranktable
              nfs: # 此处是通过NFS方式挂载ranktable
                server: 127.0.0.1
                path: /user/mindx-dl/ranktable/default.default-test-mindspore
            - name: reset-config
              hostPath:
                path: /user/restore/reset/default.reset-config-default-test-mindspore